# เอกสารอธิบายการทำงานของระบบ ESP8266 และ MEGA2560

## 1. บทนำ

ระบบนี้ใช้ไมโครคอนโทรลเลอร์ ESP8266 และ Arduino MEGA2560 ในการเชื่อมต่อเซ็นเซอร์วัดอุณหภูมิ ความชื้น และก๊าซ CO2 พร้อมทั้งควบคุมรีเลย์เพื่อเปิด/ปิดปั๊มน้ำอัตโนมัติ โดยใช้แพลตฟอร์ม Blynk สำหรับการแสดงผลและควบคุมผ่านอินเทอร์เน็ต

## 2. ฮาร์ดแวร์ที่ใช้

- ESP8266 (NodeMCU)
- Arduino MEGA2560
- เซ็นเซอร์วัดอุณหภูมิและความชื้น (DHT11)
- เซ็นเซอร์วัดก๊าซ CO2
- รีเลย์ 1 ช่อง
- โมดูลสื่อสารแบบ SoftwareSerial สำหรับเชื่อมต่อ ESP8266 กับ MEGA2560

## 3. การทำงานของระบบ

### 3.1 การเชื่อมต่อเครือข่าย

- ESP8266 ทำหน้าที่เชื่อมต่อกับ WiFi โดยใช้ SSID และ Password ที่กำหนดไว้
- ใช้ Blynk ในการรับส่งข้อมูลเซ็นเซอร์และควบคุมอุปกรณ์ผ่านอินเทอร์เน็ต
- ใช้ `NTPClient` เพื่อซิงค์เวลา UTC+7

### 3.2 การอ่านค่าจากเซ็นเซอร์

- MEGA2560 อ่านค่าจากเซ็นเซอร์ DHT11 (อุณหภูมิและความชื้น)
- อ่านค่าก๊าซ CO2 ผ่านเซ็นเซอร์ CO2 ที่เชื่อมต่อกับขาอนาล็อกของ MEGA2560
- ค่าที่ได้ถูกประมวลผลและส่งไปยัง ESP8266 ผ่าน `SoftwareSerial`

### 3.3 การส่งข้อมูลไปยัง Blynk

- ESP8266 รับข้อมูลจาก MEGA2560 และอัปโหลดค่าเซ็นเซอร์ไปยัง Blynk ผ่าน `virtualWrite`
- ข้อมูลที่ส่งประกอบไปด้วย:
  - อุณหภูมิ (V0)
  - ความชื้น (V1)
  - ค่าก๊าซ CO2 (V2)

### 3.4 การควบคุมปั๊มน้ำ

- ระบบจะเปิดปั๊มน้ำเมื่อค่าความชื้นต่ำกว่า 50%
- ปั๊มน้ำจะทำงานเป็นเวลา 1 นาที หรือจนกว่าค่าความชื้นจะถึง 60%
- ใช้ `digitalWrite` เพื่อควบคุมรีเลย์ (HIGH = เปิด, LOW = ปิด)

### 3.5 การควบคุมจาก Blynk

- สามารถสั่งรีบูต ESP8266 ผ่านแอป Blynk โดยส่งค่าคำสั่ง "reboot"
- สามารถดูค่าความชื้น อุณหภูมิ และ CO2 ผ่านแอป

## 4. ESP8266

### 4.1 ฟังก์ชัน `setup()`

- กำหนดค่าการเชื่อมต่อ WiFi
- เริ่มต้นการทำงานของ `Blynk`
- กำหนดให้ ESP8266 เป็น Web Server
- ตั้งค่าขารีเลย์เป็น OUTPUT

### 4.2 ฟังก์ชัน `loop()`

- อัปเดต Blynk
- อ่านค่าจาก MEGA2560 และส่งไปยัง Blynk ทุก 15 วินาที
- ตรวจสอบและควบคุมปั๊มน้ำ

### 4.3 ฟังก์ชัน `getParsedData()`

- รับข้อมูลจาก MEGA2560 ผ่าน `SoftwareSerial`
- แยกค่าอุณหภูมิ, ความชื้น และ CO2 ออกจากข้อความที่ได้รับ

### 4.4 ฟังก์ชัน `sendToBlynk()`

- ส่งค่าต่างๆ ไปยัง Blynk เพื่อแสดงผล
- ตรวจสอบเงื่อนไขแจ้งเตือนอุณหภูมิสูงเกินกำหนด

### 4.5 ฟังก์ชัน `handleRoot()`

- แสดงข้อมูลเซ็นเซอร์ผ่านเว็บเซิร์ฟเวอร์ของ ESP8266

## 5. Arduino MEGA2560

### 5.1 ฟังก์ชัน `setup()`

- เริ่มต้นการทำงานของ `SoftwareSerial`
- เริ่มต้นการทำงานของ `DHT`
- ตั้งค่าขารีเลย์เป็น OUTPUT

### 5.2 ฟังก์ชัน `loop()`

- อ่านค่าเซ็นเซอร์ `DHT` และ `MG-811`
- ควบคุมการทำงานของปั๊มน้ำตามค่าความชื้น
- ส่งข้อมูลไปยัง ESP8266

#### 5.2.1 อ่านค่าเซ็นเซอร์

- ทุกๆ 2 วินาที (2000 มิลลิวินาที) ระบบจะทำการอ่านค่าจากเซ็นเซอร์ DHT11 เพื่อได้ค่าอุณหภูมิ (`temp_c`) และความชื้น (`humidity`).
- ค่าจากเซ็นเซอร์ CO2 จะถูกอ่านจากเซ็นเซอร์ MG-811 ผ่านฟังก์ชัน `SensorRead()` ซึ่งจะทำการคำนวณค่า CO2 ในหน่วย PPM (Parts Per Million) และจัดเก็บในตัวแปร `CO2Percentage`.

#### 5.2.2 ควบคุมการทำงานของปั๊มน้ำ

- หากค่าความชื้น (`humidity`) ต่ำกว่า 50% ระบบจะทำการเปิดปั๊มน้ำโดยใช้คำสั่ง `digitalWrite(RELAY_PIN, HIGH)` ซึ่งจะทำให้รีเลย์ (และปั๊มน้ำ) ทำงาน.
- ถ้าปั๊มน้ำเปิดอยู่และเวลาผ่านไป 1 นาที (หรือค่าความชื้นเพิ่มขึ้นถึง 60%) ระบบจะทำการปิดปั๊มน้ำโดยใช้คำสั่ง `digitalWrite(RELAY_PIN, LOW)`.

#### 5.2.3 ส่งข้อมูลไปยัง ESP8266

- ทุกๆ 2 วินาที ข้อมูลที่ได้จากเซ็นเซอร์ (อุณหภูมิ, ความชื้น, และ CO2) จะถูกส่งไปยัง ESP8266 เพื่อส่งไปยัง Blynk หรือแสดงผลผ่านเว็บเซิร์ฟเวอร์ที่ ESP8266 โฮสต์.
- ข้อมูลจะถูกส่งในรูปแบบข้อความที่รวมข้อมูลทุกอย่าง เช่น "Temperature: 25 °C, Humidity: 45%, CO2: 350%, Pump: ON".

### 5.3 ฟังก์ชัน `SensorRead()`

- อ่านค่าจากเซ็นเซอร์ CO2 (โดยใช้ฟังก์ชัน MGReadCO2())
- อ่านค่าความชื้นและอุณหภูมิจากเซ็นเซอร์ DHT11
- หากการอ่านค่าสำเร็จ ค่าของอุณหภูมิและความชื้นจะถูกแสดงใน Serial Monitor
- หากการอ่านล้มเหลว (เช่น เซ็นเซอร์ DHT11 ไม่สามารถอ่านค่าได้) จะมีข้อความแจ้งเตือนว่า "Failed to read from DHT sensor!"

### 5.4 ฟังก์ชัน `MGReadCO2()`

- อ่านค่าจากเซ็นเซอร์ (ด้วยฟังก์ชัน analogRead())
- แปลงค่าอนาล็อกเป็นแรงดัน (Voltage)
- คำนวณและแปลงค่าแรงดันนี้เป็นปริมาณ CO2 (ใน PPM) โดยใช้สมการที่กำหนดไว้

### 5.5 ฟังก์ชัน `sendToESP8266()`

- ทำหน้าที่ส่งข้อมูลที่ได้จากเซ็นเซอร์ไปยัง ESP8266 ซึ่งจะส่งผ่าน SoftwareSerial ไปยัง ESP8266 เพื่อส่งข้อมูลไปยังแพลตฟอร์ม Blynk หรือแสดงผลผ่านเว็บเซิร์ฟเวอร์

### 5.6 การควบคุมรีเลย์ (Relay Control)

  การควบคุมรีเลย์ทำโดยการใช้พินขา 4 (RELAY_PIN) ซึ่งจะถูกตั้งค่าเป็น OUTPUT และควบคุมการเปิดหรือปิดปั๊มน้ำ

- หากค่าความชื้นต่ำกว่า 50% ระบบจะเปิดปั๊มน้ำ
- หากค่าความชื้นสูงถึง 60% หรือเวลาผ่านไป 1 นาที ปั๊มน้ำจะถูกปิด
